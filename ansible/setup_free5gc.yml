---
- name: Common Setup for All Nodes
  hosts: all
  become: yes
  tasks:
    # --- Network Persistence Setup (Prevents settings loss on reboot) ---
    - name: Disable Cloud-Init Network Management
      copy:
        dest: /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg
        content: "network: {config: disabled}\n"

    - name: Remove Cloud-Init Generated Netplan
      file:
        path: /etc/netplan/50-cloud-init.yaml
        state: absent

    - name: Create Persistent Netplan Config
      copy:
        dest: /etc/netplan/01-netcfg.yaml
        content: |
          network:
            version: 2
            renderer: networkd
            ethernets:
              enp0s3:
                dhcp4: true
                dhcp4-overrides:
                  use-dns: false
                nameservers:
                  addresses: [8.8.8.8, 8.8.4.4]
              enp0s8:
                dhcp4: no
                addresses:
                  - {{ ansible_host }}/24

    - name: Apply Netplan Immediately
      command: netplan apply
      # We run this as a task, not a handler, so DNS is fixed BEFORE apt update runs

    - name: Update apt cache and upgrade packages
      apt:
        update_cache: yes
        upgrade: yes

    - name: Install basic tools
      apt:
        name:
          - git
          - curl
          - net-tools
          - vim
        state: present

    - name: Install Helm via Snap
      snap:
        name: helm
        classic: yes

- name: Configure K8s Nodes (ns & ns2)
  hosts: k8s_nodes
  become: yes
  tasks:
    # --- Kernel & GTP5G Setup ---
    - name: Install dependencies for gtp5g
      apt:
        name:
          - make
          - gcc
          - g++
          - linux-headers-{{ ansible_kernel }}
        state: present

    - name: Clone gtp5g repository
      git:
        repo: 'https://github.com/free5gc/gtp5g.git'
        dest: /usr/src/gtp5g
        force: yes

    - name: Build and install gtp5g module
      shell: |
        make clean && make && make install
      args:
        chdir: /usr/src/gtp5g
      register: gtp5g_install
      changed_when: "'install' in gtp5g_install.stdout"

    # --- Sysctl Networking Setup ---
    - name: Load kernel modules for K8s
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter

    - name: Load overlay module
      command: modprobe overlay

    - name: Load br_netfilter module
      command: modprobe br_netfilter

    - name: Configure Sysctl for K8s and 5G
      sysctl:
        name: "{{ item }}"
        value: '1'
        sysctl_set: yes
        state: present
        reload: yes
      loop:
        - net.ipv4.ip_forward
        - net.bridge.bridge-nf-call-iptables
        - net.bridge.bridge-nf-call-ip6tables

    - name: Ensure forwarding and bridge-nf sysctls
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        sysctl_set: yes
        state: present
        reload: yes
      loop:
        - { key: 'net.ipv4.ip_forward', value: '1' }
        - { key: 'net.bridge.bridge-nf-call-iptables', value: '1' }
        - { key: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }

    - name: Ensure FORWARD policy is ACCEPT (temporary safety)
      command: iptables -P FORWARD ACCEPT
      when: ansible_facts['os_family'] == 'Debian'

    # --- MicroK8s Installation ---
    - name: Install MicroK8s via Snap
      snap:
        name: microk8s
        classic: yes
        channel: "1.32/stable"

    - name: Add user to microk8s group
      user:
        name: "{{ ansible_user }}"
        groups: microk8s
        append: yes

    - name: Create kubectl alias
      shell: snap alias microk8s.kubectl kubectl
      ignore_errors: yes

    - name: Create .kube directory for user
      file:
        path: /home/{{ ansible_user }}/.kube
        state: directory
        mode: '0700'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Generate kube config
      shell: microk8s config > /home/{{ ansible_user }}/.kube/config
      args:
        creates: /home/{{ ansible_user }}/.kube/config

    - name: Fix kube config permissions
      file:
        path: /home/{{ ansible_user }}/.kube/config
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'

    # --- MicroK8s Advanced Configuration (Tutorial Specifics) ---
    - name: Wait for MicroK8s to be ready
      command: microk8s status --wait-ready
      changed_when: false

    - name: Set Node IP in Kubelet args (Fixes 10.0.2.15 issue)
      lineinfile:
        path: /var/snap/microk8s/current/args/kubelet
        line: "--node-ip={{ ansible_host }}"
        insertafter: EOF
      notify: Restart MicroK8s

    - name: Allow IP Forwarding in Calico CNI (Required for UPF)
      replace:
        path: /var/snap/microk8s/current/args/cni-network/cni.yaml
        regexp: '"type": "calico",'
        replace: '"type": "calico", "container_settings": { "allow_ip_forwarding": true },'
      notify: Restart MicroK8s

    - name: Enable MicroK8s Addons
      command: microk8s enable dns hostpath-storage
      register: enable_addons
      changed_when: "'already enabled' not in enable_addons.stdout"

    - name: Install Multus CNI
      command: microk8s kubectl apply -f https://raw.githubusercontent.com/k8snetworkplumbingwg/multus-cni/master/deployments/multus-daemonset.yml
      register: install_multus
      changed_when: "'created' in install_multus.stdout or 'configured' in install_multus.stdout"

  handlers:
    - name: Restart MicroK8s
      shell: microk8s stop && microk8s start
      args:
        executable: /bin/bash

- name: Deploy MongoDB PV/PVC on Control Plane (ns)
  hosts: ns
  become: yes
  tasks:
    - name: Create kubedata directory for MongoDB PV
      file:
        path: /home/vagrant/kubedata
        state: directory
        mode: '0755'
        owner: vagrant
        group: vagrant

    - name: Create certdata directory for cert PV
      file:
        path: /home/vagrant/certdata
        state: directory
        mode: '0755'
        owner: vagrant
        group: vagrant

    - name: Copy MongoDB PV manifest
      copy:
        src: mongopv.yaml
        dest: /home/vagrant/mongopv.yaml
        owner: vagrant
        group: vagrant
        mode: '0644'

    - name: Copy MongoDB PVC manifest
      copy:
        src: mongopvc.yaml
        dest: /home/vagrant/mongopvc.yaml
        owner: vagrant
        group: vagrant
        mode: '0644'

    - name: Apply MongoDB PV
      command: microk8s kubectl apply -f /home/vagrant/mongopv.yaml
      register: apply_pv
      changed_when: "'created' in apply_pv.stdout or 'configured' in apply_pv.stdout"

    - name: Apply MongoDB PVC (cert PV)
      command: microk8s kubectl apply -f /home/vagrant/mongopvc.yaml
      register: apply_pvc
      changed_when: "'created' in apply_pvc.stdout or 'configured' in apply_pvc.stdout"

    - name: Verify PVs are created
      command: microk8s kubectl get pv
      register: pv_status
      changed_when: false

    - name: Show PV status
      debug:
        var: pv_status.stdout_lines

# - name: Create MicroK8s Cluster (Join ns2 to ns)
#   hosts: ns
#   become: yes
#   tasks:
#     - name: Generate join token on control plane (ns)
#       command: microk8s add-node --token-ttl 3600
#       register: add_node_output
#       changed_when: false

#     - name: Extract join command for worker node (prefer private IP)
#       set_fact:
#         join_line_192: "{{ add_node_output.stdout_lines | select('match', '192\\.168\\.56\\.119') | list | first | default('') }}"

#     - name: "Fallback: extract any join line if private IP not found"
#       set_fact:
#         join_line_any: "{{ add_node_output.stdout_lines | select('match', '^microk8s join') | list | first | default('') }}"

#     - name: Build normalized join command (control-plane join)
#       set_fact:
#         join_command: >-
#           {{ (join_line_192 if join_line_192 != '' else join_line_any) | regex_replace('\\s*--worker\\s*$', '') }}

#     - name: Display join command
#       debug:
#         msg: "Join command: {{ join_command }}"

# - name: Join ns2 to MicroK8s Cluster
#   hosts: ns2
#   become: yes
#   tasks:
#     - name: Check if already joined to cluster
#       command: microk8s status
#       register: microk8s_status
#       changed_when: false
#       failed_when: false

#     - name: Join cluster as worker node (use private IP for control plane)
#       command: "{{ hostvars['ns']['join_command'] | regex_replace('10\\.0\\.2\\.15','192.168.56.119') }}"
#       when: "'This MicroK8s deployment is acting as a node in a cluster' not in microk8s_status.stdout"
#       register: join_result

#     - name: Show join result
#       debug:
#         var: join_result.stdout_lines
#       when: join_result is changed

# - name: Verify Cluster Status
#   hosts: ns
#   become: yes
#   tasks:
#     - name: Wait for ns2 to join the cluster
#       command: microk8s kubectl get nodes
#       register: nodes_status
#       until: "'ns2' in nodes_status.stdout and 'Ready' in nodes_status.stdout"
#       retries: 12
#       delay: 10
#       changed_when: false

- name: Collect pod images on control plane
  hosts: ns
  become: yes
  run_once: true
  tasks:
    - name: List container images from all pods (one per line)
      command: >-
        bash -lc "microk8s kubectl get pods --all-namespaces -o jsonpath='{range .items[*]}{range .spec.containers[*]}{.image}{"\n"}{end}{end}'"
      register: pod_images_raw
      changed_when: false

    - name: Set images fact (unique, non-empty)
      set_fact:
        pod_images: "{{ pod_images_raw.stdout_lines | map('trim') | select('!=', '') | list | unique }}"

    - name: Show discovered images
      debug:
        var: pod_images

- name: Pull and load images to MicroK8s on ns and ns2
  hosts: ns:ns2
  become: yes
  tasks:
    - name: Ensure pod_images fact exists (copied from control plane)
      set_fact:
        images_to_pull: "{{ hostvars['ns'].pod_images | default([]) }}"

    - name: Pull image into MicroK8s (ctr pull)
      vars:
        image: "{{ item }}"
      command: microk8s ctr image pull {{ image }}
      register: pull_result
      failed_when: false
      with_items: "{{ images_to_pull }}"

    - name: Show pull results
      debug:
        var: pull_result.results

- name: Deploy Helm chart to MicroK8s (control plane)
  hosts: ns
  become: yes
  tasks:
    - name: Create namespace free5gc if not present
      command: microk8s kubectl create namespace free5gc
      register: ns_create
      failed_when: false

    - name: Install Helm chart for free5gc
      command: >-
        helm -n free5gc install free5gc-v1 ./free5gc/ --wait --timeout 10m || helm -n free5gc upgrade --install free5gc-v1 ./free5gc/ --wait --timeout 10m
      args:
        chdir: /home/vagrant/free5gc-helm/charts
      register: helm_install
      failed_when: helm_install.rc not in [0]

    - name: Show helm install output
      debug:
        var: helm_install.stdout_lines

- name: Configure UE/RAN Node (VM3)
  hosts: ue_node
  become: yes
  tasks:
    - name: Install UERANSIM build dependencies
      apt:
        name:
          - make
          - gcc
          - g++
          - libsctp-dev
          - lksctp-tools
          - iproute2
        state: present

    - name: Install CMake via Snap
      snap:
        name: cmake
        classic: yes

    - name: Ensure UERANSIM folder exists (shared via Vagrant)
      file:
        path: /home/{{ ansible_user }}/UERANSIM
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'
      become: no